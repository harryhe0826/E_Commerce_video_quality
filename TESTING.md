# 测试指南

本文档提供了完整的测试流程，确保视频质量评估系统的各项功能正常运行。

## 目录

1. [环境准备](#环境准备)
2. [功能测试](#功能测试)
3. [性能测试](#性能测试)
4. [错误处理测试](#错误处理测试)
5. [端到端测试](#端到端测试)

## 环境准备

### 1. 启动系统

确保后端和前端都已启动：

```bash
# 终端 1 - 启动后端
cd backend
source venv/bin/activate
./start-backend.sh

# 终端 2 - 启动前端
cd frontend
./start-frontend.sh
```

验证服务状态：
- 前端: http://localhost:5173 应该能正常访问
- 后端: http://localhost:8000/docs 应该显示 API 文档
- 健康检查: http://localhost:8000/api/health 应该返回 `{"status":"ok"}`

### 2. 准备测试视频

在项目根目录创建测试视频目录：

```bash
mkdir -p test_videos
```

准备以下测试视频（可以使用任意符合要求的视频）：

| 文件名 | 要求 | 预期结果 |
|--------|------|----------|
| `good_sample.mp4` | 有明显钩子、有CTA、节奏快、产品清晰 | 总分 >80 分，等级 A |
| `no_hook.mp4` | 前3秒平淡无奇 | 黄金3秒得分 <60 |
| `no_cta.mp4` | 结尾无行动指令 | CTA 得分 = 0 |
| `slow_cuts.mp4` | 镜头切换慢（ASL >4秒） | 剪辑节奏得分 <70 |
| `blurry_product.mp4` | 产品模糊或占比小 | 视觉重心得分 <70 |
| `invalid.txt` | 非视频文件 | 上传失败 |
| `large_file.mp4` | >100MB | 上传失败 |

## 功能测试

### 测试 1: 视频上传

#### 1.1 拖拽上传

**步骤**:
1. 访问 http://localhost:5173
2. 将 `good_sample.mp4` 拖拽到上传区域
3. 观察上传进度

**预期结果**:
- [ ] 显示上传进度条
- [ ] 进度条平滑增长
- [ ] 上传成功后显示视频信息（文件名、时长、分辨率）
- [ ] 显示"开始分析"按钮

#### 1.2 点击上传

**步骤**:
1. 点击上传区域
2. 在文件选择器中选择 `no_hook.mp4`
3. 确认选择

**预期结果**:
- [ ] 文件选择器正确打开
- [ ] 上传成功
- [ ] 显示视频预览

#### 1.3 格式验证

**步骤**:
1. 尝试上传 `invalid.txt`
2. 观察错误提示

**预期结果**:
- [ ] 显示错误提示："不支持的文件格式"
- [ ] 上传被阻止
- [ ] 提示支持的格式：mp4, mov, avi

#### 1.4 大小限制

**步骤**:
1. 尝试上传 >100MB 的视频文件
2. 观察错误提示

**预期结果**:
- [ ] 显示错误提示："文件大小超过限制"
- [ ] 上传被阻止

### 测试 2: 视频分析

#### 2.1 完整分析流程

**步骤**:
1. 上传 `good_sample.mp4`
2. 点击"开始分析"按钮
3. 等待分析完成（约1-2分钟）
4. 观察分析过程

**预期结果**:
- [ ] 显示加载动画和"正在分析视频，请稍候..."
- [ ] 显示提示："这可能需要1-2分钟，请耐心等待"
- [ ] 分析完成后自动跳转到结果页面
- [ ] 无错误提示

#### 2.2 黄金3秒检测

**测试用例 A: 有明显钩子**

视频要求：前3秒包含疑问句或冲突感词汇

**步骤**:
1. 上传包含钩子的视频
2. 开始分析
3. 查看结果中的"结构化分析 > 黄金3秒"

**预期结果**:
- [ ] 黄金3秒得分 >70
- [ ] `detected: true`
- [ ] 显示钩子类型（question 或 conflict）
- [ ] 显示具体内容（前50字）

**测试用例 B: 无钩子**

视频要求：前3秒平淡无奇

**步骤**:
1. 上传 `no_hook.mp4`
2. 开始分析
3. 查看结果

**预期结果**:
- [ ] 黄金3秒得分 <60
- [ ] `detected: false`
- [ ] 问题列表中显示："开头缺乏吸引力"

#### 2.3 CTA 检测

**测试用例 A: 有 CTA**

视频要求：最后5秒包含"点击"、"购买"等词汇

**步骤**:
1. 上传包含 CTA 的视频
2. 开始分析
3. 查看结果中的"结构化分析 > CTA检测"

**预期结果**:
- [ ] CTA 得分 = 100
- [ ] `detected: true`
- [ ] 显示 CTA 内容

**测试用例 B: 无 CTA**

视频要求：结尾无行动指令

**步骤**:
1. 上传 `no_cta.mp4`
2. 开始分析
3. 查看结果

**预期结果**:
- [ ] CTA 得分 = 0
- [ ] `detected: false`
- [ ] 问题列表中显示："缺少结尾行动指令"

#### 2.4 剪辑节奏分析

**测试用例 A: 快节奏**

视频要求：ASL < 2秒

**预期结果**:
- [ ] 剪辑节奏得分 >80
- [ ] 平均镜头长度 <2.0秒
- [ ] 分析文本："节奏良好" 或 "节奏偏快"

**测试用例 B: 慢节奏**

视频要求：ASL >4秒，包含超长镜头

**预期结果**:
- [ ] 剪辑节奏得分 <70
- [ ] 平均镜头长度 >4.0秒
- [ ] 检测到超长镜头列表（>5秒的镜头）
- [ ] 问题列表中显示："平均镜头长度过长"

#### 2.5 视觉重心分析

**测试用例 A: 产品清晰居中**

视频要求：产品占比20%-50%，位置居中，画面清晰

**预期结果**:
- [ ] 视觉重心得分 >80
- [ ] 产品占比在 0.2-0.5 之间
- [ ] 中心度 >0.7
- [ ] 模糊帧数量少

**测试用例 B: 产品模糊或偏小**

视频要求：产品占比 <20% 或模糊

**预期结果**:
- [ ] 视觉重心得分 <70
- [ ] 问题列表中显示："产品在画面中过小" 或 "存在模糊问题"

### 测试 3: AI 评估

**步骤**:
1. 上传任意视频
2. 确保启用 AI 评估（`use_ai=true`）
3. 等待分析完成
4. 查看"AI 智能评估"卡片

**预期结果**:
- [ ] 显示综合评价（2-3句话）
- [ ] 显示优势列表（至少1条）
- [ ] 显示劣势列表（至少1条）
- [ ] 显示改进建议（至少2条）
- [ ] 所有内容语句通顺，与视频内容相关

**验证 JSON 格式**:
打开浏览器开发者工具，检查 API 响应：
- [ ] `ai_evaluation.summary` 存在且非空
- [ ] `ai_evaluation.strengths` 是数组
- [ ] `ai_evaluation.weaknesses` 是数组
- [ ] `ai_evaluation.recommendations` 是数组

### 测试 4: 结果展示

**步骤**:
1. 完成任意视频的分析
2. 查看结果页面

**预期结果**:

#### 4.1 总分卡片
- [ ] 大数字显示总分（72px，粗体）
- [ ] 分数颜色根据等级变化（A=绿色，B=蓝色，C=橙色）
- [ ] 显示等级徽章（A+, A, B+, B, C）
- [ ] 显示"综合评分"标签

#### 4.2 维度详情
- [ ] 显示两个维度卡片：结构化分析、视觉动力学
- [ ] 每个维度显示圆形进度条
- [ ] 进度条颜色与等级一致
- [ ] 显示具体指标：
  - 结构化：黄金3秒分数、CTA分数
  - 视觉：剪辑节奏分数、视觉重心分数
- [ ] 如果检测到特征，显示"检测到"标签

#### 4.3 问题列表
- [ ] 如果有问题，显示问题卡片
- [ ] 问题按严重程度排序（高 > 中 > 低）
- [ ] 严重程度用颜色区分：
  - high = 红色
  - medium = 橙色
  - low = 灰色
- [ ] 每个问题显示具体描述

#### 4.4 返回按钮
- [ ] 显示"返回"按钮
- [ ] 点击返回到首页

## 性能测试

### 测试 5: 处理时间

测试不同时长的视频处理时间：

| 视频时长 | 预期处理时间 | 实际处理时间 | 通过 |
|---------|------------|-------------|-----|
| 10秒 | <30秒 | _____ | ☐ |
| 30秒 | <2分钟 | _____ | ☐ |
| 60秒 | <5分钟 | _____ | ☐ |

**测试方法**:
1. 记录点击"开始分析"的时间
2. 记录结果页面显示的时间
3. 计算时间差

**如果超时**:
- 检查是否有 GPU 可用
- 查看后端日志中的瓶颈环节
- 考虑降低视频分辨率或使用更小的模型

### 测试 6: 并发处理

**步骤**:
1. 在两个浏览器标签页同时上传不同视频
2. 同时点击"开始分析"
3. 观察处理过程

**预期结果**:
- [ ] 两个分析任务都能正常完成
- [ ] 处理时间略有延长（正常现象）
- [ ] 无错误或崩溃

## 错误处理测试

### 测试 7: 网络错误

#### 7.1 后端离线

**步骤**:
1. 停止后端服务
2. 尝试上传视频
3. 观察错误提示

**预期结果**:
- [ ] 显示网络错误提示
- [ ] 提示用户检查后端服务

#### 7.2 分析中断

**步骤**:
1. 开始分析视频
2. 在分析过程中停止后端服务
3. 观察错误提示

**预期结果**:
- [ ] 显示错误提示："分析失败"
- [ ] 提供"重试"按钮
- [ ] 点击重试后重新开始分析

### 测试 8: API 错误

#### 8.1 Claude API 密钥无效

**步骤**:
1. 编辑 `backend/.env`，将 `ANTHROPIC_API_KEY` 改为无效值
2. 重启后端
3. 上传视频并开始分析

**预期结果**:
- [ ] 规则评分仍然正常完成
- [ ] AI 评估部分不显示或显示降级信息
- [ ] 后端日志中记录 API 错误

#### 8.2 视频文件损坏

**步骤**:
1. 准备一个损坏的 mp4 文件（截断文件）
2. 上传并尝试分析

**预期结果**:
- [ ] 显示错误提示："视频处理失败"
- [ ] 提供详细错误信息
- [ ] 不会导致后端崩溃

### 测试 9: 边界条件

#### 9.1 超短视频

**步骤**:
1. 上传时长 <5秒 的视频
2. 开始分析

**预期结果**:
- [ ] 分析能够完成
- [ ] CTA 检测可能失败（正常，因为没有"最后5秒"）
- [ ] 其他指标正常评分

#### 9.2 超长视频

**步骤**:
1. 上传时长 >120秒 的视频
2. 开始分析

**预期结果**:
- [ ] 分析能够完成（时间较长）
- [ ] 评分逻辑正常
- [ ] 内存使用不会过高

#### 9.3 无音频视频

**步骤**:
1. 上传无音轨的视频
2. 开始分析

**预期结果**:
- [ ] ASR 返回空文本
- [ ] 其他分析正常进行
- [ ] 黄金3秒和 CTA 仅基于 OCR 和视觉分析

## 端到端测试

### 测试 10: 完整用户流程

**场景**: 新用户首次使用系统

**步骤**:
1. 访问首页 http://localhost:5173
2. 阅读页面说明
3. 拖拽上传 `good_sample.mp4`
4. 观察上传进度
5. 点击"开始分析"
6. 等待分析完成
7. 查看总分和等级
8. 展开各维度详情
9. 阅读 AI 评估建议
10. 点击"返回"按钮
11. 再次上传另一个视频

**预期结果**:
- [ ] 整个流程顺畅，无卡顿
- [ ] 所有交互响应迅速
- [ ] 信息展示清晰易懂
- [ ] 可以连续分析多个视频

### 测试 11: API 端到端测试

使用 `curl` 测试完整 API 流程：

**步骤 1: 上传视频**
```bash
curl -X POST http://localhost:8000/api/videos/upload \
  -F "file=@test_videos/good_sample.mp4"
```

记录响应中的 `id` 字段（例如 `vid_xxx`）

**步骤 2: 开始分析**
```bash
curl -X POST "http://localhost:8000/api/analysis/start/vid_xxx?use_ai=true"
```

**步骤 3: 获取结果**
```bash
curl http://localhost:8000/api/analysis/result/by-video/vid_xxx
```

**预期结果**:
- [ ] 每个请求都返回 200 状态码
- [ ] 响应 JSON 格式正确
- [ ] 分析结果包含所有必要字段

## 测试报告模板

```markdown
## 测试报告

**测试日期**: ___________
**测试人员**: ___________
**环境**: macOS / Ubuntu / Windows
**Python 版本**: ___________
**Node.js 版本**: ___________

### 测试结果总结

| 测试类别 | 通过 | 失败 | 跳过 |
|---------|------|------|------|
| 功能测试 | __ | __ | __ |
| 性能测试 | __ | __ | __ |
| 错误处理 | __ | __ | __ |
| 端到端测试 | __ | __ | __ |

### 发现的问题

1. **问题描述**: ___________
   - 严重程度: 高 / 中 / 低
   - 重现步骤: ___________
   - 截图: ___________

2. ...

### 性能数据

- 平均上传时间: _____ 秒
- 平均分析时间（30秒视频）: _____ 秒
- 内存使用峰值: _____ MB

### 建议

1. ___________
2. ___________
```

## 自动化测试（未来）

目前的测试主要是手动测试。未来可以考虑：

1. **单元测试**: 使用 pytest 测试各个分析器
2. **集成测试**: 测试 API 端点
3. **UI 测试**: 使用 Playwright 或 Selenium
4. **CI/CD**: 集成到 GitHub Actions

## 附录：测试命令速查

```bash
# 检查后端健康
curl http://localhost:8000/api/health

# 查看 API 文档
open http://localhost:8000/docs

# 查看后端日志
tail -f backend/logs/app.log

# 检查数据库
sqlite3 backend/video_quality.db "SELECT * FROM videos;"

# 清空测试数据
rm -rf backend/uploads/*
rm -rf backend/temp/*
sqlite3 backend/video_quality.db "DELETE FROM videos; DELETE FROM analysis_results;"
```

## 常见问题

### Q: 测试时分析一直卡在某个步骤？
A: 查看后端日志 `backend/logs/app.log`，定位卡住的环节。常见原因：
- Whisper 首次运行下载模型
- GPU 不可用导致处理缓慢
- Claude API 超时

### Q: 如何跳过某些依赖的测试？
A: 如果某些库（如 PaddleOCR）未安装，系统会自动降级，相关功能返回空结果。

### Q: 测试视频从哪里获取？
A: 可以使用任意带货短视频，或自己录制测试视频。

---

**测试愉快！如有问题请参考 README.md 或提交 Issue。**
